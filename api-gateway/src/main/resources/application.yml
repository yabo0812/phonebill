# API Gateway ê¸°ë³¸ ì„¤ì •
# Spring Boot 3.2 + Spring Cloud Gateway

server:
  port: ${SERVER_PORT:8080}
  netty:
    connection-timeout: ${SERVER_NETTY_CONNECTION_TIMEOUT:30s}
    idle-timeout: ${SERVER_NETTY_IDLE_TIMEOUT:60s}
  http2:
    enabled: true
  # HTTP í—¤ë” í¬ê¸° ì œí•œ ì„¤ì •
  max-http-header-size: 64KB
  max-http-request-header-size: 64KB

spring:
  application:
    name: api-gateway
  
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}

  # Spring Cloud Gateway ì„¤ì •
  cloud:
    gateway:
      # HTTP ê´€ë ¨ ì„¤ì •
      httpclient:
        pool:
          max-connections: 1000
          max-idle-time: 30s
        response-timeout: 60s
        connect-timeout: 5000
      
      default-filters:
        - name: AddRequestHeader
          args:
            name: X-Gateway-Request
            value: API-Gateway
        - name: AddResponseHeader
          args:
            name: X-Gateway-Response
            value: API-Gateway
      
      # Global CORS ì„¤ì •
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origin-patterns: "*"
            allowed-methods: 
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
              - HEAD
            allowed-headers: "*"
            allow-credentials: true
            max-age: 3600
      
      # Discovery ì„¤ì • ë¹„í™œì„±í™” (ì§ì ‘ ë¼ìš°íŒ… ì‚¬ìš©)
      discovery:
        locator:
          enabled: false

  # JSON ì„¤ì •
  jackson:
    default-property-inclusion: non_null
    serialization:
      write-dates-as-timestamps: false
    deserialization:
      fail-on-unknown-properties: false

# CORS
cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:3000}

# JWT í† í° ì„¤ì •
jwt:
  secret: ${JWT_SECRET:}
  access-token-validity: ${JWT_ACCESS_TOKEN_VALIDITY:180000}
  refresh-token-validity: ${JWT_ACCESS_TOKEN_VALIDITY:86400000}

# ì„œë¹„ìŠ¤ URL ì„¤ì •
services:
  user-service:
    url: ${USER_SERVICE_URL:http://localhost:8081}
  bill-service:
    url: ${BILL_SERVICE_URL:http://localhost:8082}
  product-service:
    url: ${PRODUCT_SERVICE_URL:http://localhost:8083}
  kos-mock:
    url: ${KOS_MOCK_URL:http://localhost:8084}

# Circuit Breaker ì„¤ì •
resilience4j:
  circuitbreaker:
    instances:
      auth-service-cb:
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        sliding-window-size: 10
        minimum-number-of-calls: 5
        permitted-number-of-calls-in-half-open-state: 3
      bill-service-cb:
        failure-rate-threshold: 60
        wait-duration-in-open-state: 30s
        sliding-window-size: 20
        minimum-number-of-calls: 10
      product-service-cb:
        failure-rate-threshold: 60
        wait-duration-in-open-state: 30s
        sliding-window-size: 20
        minimum-number-of-calls: 10
      kos-mock-cb:
        failure-rate-threshold: 70
        wait-duration-in-open-state: 10s
        sliding-window-size: 10
        minimum-number-of-calls: 5
  
  retry:
    instances:
      default:
        max-attempts: 3
        wait-duration: 2s
        exponential-backoff-multiplier: 2
        retry-exceptions:
          - java.net.ConnectException
          - java.net.SocketTimeoutException
          - org.springframework.web.client.ResourceAccessException

# Actuator ì„¤ì •
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
      show-components: always
    gateway:
      enabled: true
  health:
    redis:
      enabled: false
    circuitbreakers:
      enabled: true
  info:
    env:
      enabled: true
    java:
      enabled: true
    build:
      enabled: true

# ë¡œê¹… ì„¤ì •
logging:
  file:
    name: logs/api-gateway.log
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 7
      total-size-cap: 100MB
  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-},%X{spanId:-}] %logger{36} - %msg%n"
    console: "%d{HH:mm:ss.SSS} [%thread] %highlight(%-5level) %cyan([%X{traceId:-},%X{spanId:-}]) %logger{36} - %msg%n"

# OpenAPI ì„¤ì •
springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    disable-swagger-default-url: true
    # HTTP 431 ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•œ ì„¤ì •
    config-url: /v3/api-docs/swagger-config
    use-root-path: true
    # í° í—¤ë” ì²˜ë¦¬ë¥¼ ìœ„í•œ ì„¤ì •
    csrf:
      enabled: false
    # ì„œë¹„ìŠ¤ë³„ URL ë“±ë¡ (Gateway í†µí•© ìˆœì„œ)
    urls:
      - name: "ğŸ“± User Service (ì¸ì¦)"
        url: "/v3/api-docs/user"
        display-name: "User Service API"
      - name: "ğŸ’° Bill Service (ìš”ê¸ˆì¡°íšŒ)"
        url: "/v3/api-docs/bill"
        display-name: "Bill Inquiry API"
      - name: "ğŸ“¦ Product Service (ìƒí’ˆë³€ê²½)"
        url: "/v3/api-docs/product"
        display-name: "Product Change API"
      - name: "ğŸ”§ KOS Mock Service (ì™¸ë¶€ì—°ë™)"
        url: "/v3/api-docs/kos"
        display-name: "KOS Mock API"
      - name: "ğŸŒ Gateway API (ê²Œì´íŠ¸ì›¨ì´)"
        url: "/v3/api-docs/gateway"
        display-name: "API Gateway"
  use-management-port: false
  show-actuator: false

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ë³´
info:
  app:
    name: PhoneBill API Gateway
    description: í†µì‹ ìš”ê¸ˆ ê´€ë¦¬ ì„œë¹„ìŠ¤ API Gateway
    version: 1.0.0
    encoding: UTF-8
    java:
      version: 17